<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf8" />
    <style>
      #chatLog {
        overflow: scroll;
        resize: vertical;
        min-height: 200px;
        border: solid 1px;
        padding: 4;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <audio id="ringSound" preload="auto">
      <source src="./Onmtp-Ding05-1.mp3" type="audio/mp3" />
    </audio>
    <form id="chatForm">
      <div>
        <button type="submit">開始</button>
      </div>
    </form>
    <div id="chatLog"></div>
    <script src="https://fungo.kcg.edu/madoi-20211030/js/madoi.js"></script>
    <script>
        let start;
      window.addEventListener("load", () => {
        // HTML内のタグをJavaScriptから操作するために，対応するElementオブジェクトを取り出す。
        const chatForm = document.querySelector("#chatForm");
        const nameInput = document.querySelector("#name");
        const messageInput = document.querySelector("#message");
        const logDiv = document.querySelector("#chatLog");

        // ログ領域にチャットメッセージを追加する関数
        addMessage = function () {
          const millis = Date.now() - start;
          const s = Math.floor(millis / 1000) % 60;
          const m = Math.floor(millis / 60 / 1000) % 60;
          const h = Math.floor(millis / 60 / 60 / 1000) % 24;
          logDiv.innerHTML = `${(h < 10 ? '0' : '') + h}:${(m < 10 ? '0' : '') + m}:${(s < 10 ? '0' : '') + s}`;
          setTimeout(addMessage, 1000);
        };

        // Madoiライブラリを使ってサービスに接続する。引数の"room/"以降はセッション識別文字列。
        const m = new madoi.Madoi("rooms/group-d");

        // addMessage関数を共有関数として登録する。
        // プロキシが返されるので，それでaddMessageを置き換えておく。
        // ハンドラは内部で自動的に作成され，サーバからメッセージが届くと本来のaddMessageが実行される。
        addMessage = m.registerShareFunction(addMessage);

        // チャットフォームのsubmitイベントで，addMessageを実行する。
        chatForm.addEventListener("submit", (e) => {
          e.preventDefault();
          const name = nameInput.value.trim();
          const message = messageInput.value.trim();
          const ring = document.querySelector("#ringSound");
          ring.play();
          start = Date.now();
          messageInput.value = "";
          // addMessage実行。プロキシが実行される。
          addMessage();
        });

      });
    </script>
  </body>
</html>
